<!doctype html>
<!--
  ============================================================
  FILE: auth.html
  MÔ TẢ: Trang đăng nhập và đăng ký tài khoản Firebase
  ============================================================
  
  HƯỚNG DẪN SỬ DỤNG:
  1. Người dùng có thể ĐĂNG NHẬP hoặc ĐĂNG KÝ tài khoản
  2. Nhấn "Đăng ký" để chuyển đổi form đăng ký
  3. Nhấn "Đăng nhập" để quay lại form đăng nhập
  4. Sau khi đăng nhập thành công, tự động chuyển về index.html
  
  CÁC HÀM CHÍNH:
  - switchForm(): Chuyển đổi giữa đăng nhập và đăng ký
  - handleSubmit(): Xử lý khi nhấn nút submit
  - registerUser(): Đăng ký tài khoản mới với Firebase Auth
  - loginUser(): Đăng nhập với email và password
  - showError(): Hiển thị thông báo lỗi
  - clearError(): Xóa thông báo lỗi
  
  LƯU TRỮ LOCAL:
  - loginSuccess: Đánh dấu đăng nhập thành công để hiện toast
  - userEmail: Lưu email người dùng
  - userUID: Lưu UID của Firebase user
-->
<html lang="vi">
  <head>
    <!-- Meta charset UTF-8 để hỗ trợ tiếng Việt -->
    <meta charset="UTF-8" />
    <title>Đăng nhập / Đăng ký</title>
    <!-- CSS cho trang xác thực -->
    <link rel="stylesheet" href="auth.css" />
  </head>
  <body>
    <!-- Container chính chứa form đăng nhập/đăng ký -->
    <div class="auth-container">
      <!-- Box chứa các input và nút -->
      <div class="auth-box">
        <!-- Tiêu đề form - thay đổi giữa "Đăng nhập" và "Đăng ký" -->
        <h2 id="title">Đăng nhập</h2>

        <!-- Input email - bắt buộc có định dạng email hợp lệ -->
        <input type="email" id="email" placeholder="Email" />
        <!-- Input mật khẩu - ít nhất 6 ký tự theo yêu cầu Firebase -->
        <input type="password" id="password" placeholder="Mật khẩu" />

        <!-- Thông báo lỗi - hiển thị khi có lỗi đăng nhập/đăng ký -->
        <p id="errorMsg" class="error-msg"></p>

        <!-- Nút submit - gọi handleSubmit() để xử lý đăng nhập/đăng ký -->
        <button id="submitBtn" onclick="handleSubmit()">Đăng nhập</button>

        <!-- Link chuyển đổi giữa form đăng nhập và đăng ký -->
        <p class="switch">
          Chưa có tài khoản?
          <span onclick="switchForm()">Đăng ký</span>
        </p>
      </div>
    </div>

    <!-- ===== FIREBASE SDK ===== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      /* ===== FIREBASE CONFIG ===== */
      var firebaseConfig = {
        apiKey: "AIzaSyD9Vmq5O9sVpOsTtQ3qNIyggsIaobNfBMw",
        authDomain: "do-an-high.firebaseapp.com",
        databaseURL: "https://do-an-high-default-rtdb.firebaseio.com/",
        projectId: "do-an-high",
      };

      firebase.initializeApp(firebaseConfig);

      /* ===== UI STATE ===== */
      let isLogin = true;

      /* ===== HIỂN THỊ / XÓA LỖI ===== */
      function showError(message) {
        document.getElementById("errorMsg").innerText = message;
      }

      function clearError() {
        document.getElementById("errorMsg").innerText = "";
      }

      /* ===== CHUYỂN LOGIN / REGISTER ===== */
      function switchForm() {
        clearError();

        const title = document.getElementById("title");
        const btn = document.getElementById("submitBtn");
        const sw = document.querySelector(".switch");

        if (isLogin) {
          title.innerText = "Đăng ký";
          btn.innerText = "Đăng ký";
          sw.innerHTML = `Đã có tài khoản? <span onclick="switchForm()">Đăng nhập</span>`;
        } else {
          title.innerText = "Đăng nhập";
          btn.innerText = "Đăng nhập";
          sw.innerHTML = `Chưa có tài khoản? <span onclick="switchForm()">Đăng ký</span>`;
        }
        isLogin = !isLogin;
      }

      /* ===== SUBMIT ===== */
      function handleSubmit() {
        clearError();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!email || !password) {
          showError("Vui lòng nhập đầy đủ email và mật khẩu");
          return;
        }

        if (isLogin) {
          loginUser(email, password);
        } else {
          registerUser(email, password);
        }
      }

      /* ===== ĐĂNG KÝ ===== */
      function registerUser(email, password) {
        firebase
          .auth()
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const uid = userCredential.user.uid;

            firebase
              .database()
              .ref("users/" + uid)
              .set({
                email: email,
                createdAt: new Date().toISOString(),
              });

            clearError();
            alert("Đăng ký thành công! Vui lòng đăng nhập.");
            switchForm();
          })
          .catch((error) => {
            showError(error.message);
          });
      }

      /* ===== ĐĂNG NHẬP ===== */
      function loginUser(email, password) {
        firebase
          .auth()
          .signInWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const uid = userCredential.user.uid;

            firebase
              .database()
              .ref("users/" + uid)
              .once("value")
              .then((snapshot) => {
                if (snapshot.exists()) {
                  localStorage.setItem("loginSuccess", "true");
                  localStorage.setItem("userEmail", email);
                  localStorage.setItem("userUID", uid);

                  window.location.href = "index.html";
                } else {
                  showError("Tài khoản không hợp lệ");
                  firebase.auth().signOut();
                }
              });
          })
          .catch(() => {
            showError("Sai email hoặc mật khẩu");
          });
      }
    </script>
  </body>
</html>
