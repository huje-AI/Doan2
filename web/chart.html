<!doctype html>
<!--
  ============================================================
  FILE: chart.html
  M√î T·∫¢: Trang hi·ªÉn th·ªã ƒë·ªì th·ªã realtime v√† danh s√°ch th√¥ng b√°o
  ============================================================
  
  H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG:
  1. ƒê·ªí TH·ªä REALTIME:
     - Hi·ªÉn th·ªã c√¥ng su·∫•t (W) v√† l∆∞u l∆∞·ª£ng n∆∞·ªõc (mL/s) theo th·ªùi gian
     - C·∫≠p nh·∫≠t m·ªói gi√¢y t·ª´ Firebase Realtime Database
     - Gi·ªØ t·ªëi ƒëa 120 ƒëi·ªÉm (~2 ph√∫t d·ªØ li·ªáu)
     - Tr·ª•c Y tr√°i: C√¥ng su·∫•t (W) - m√†u xanh d∆∞∆°ng
     - Tr·ª•c Y ph·∫£i: L∆∞u l∆∞·ª£ng n∆∞·ªõc (mL/s) - m√†u xanh l√°
  
  2. TH√îNG B√ÅO:
     - Hi·ªÉn th·ªã l·ªãch s·ª≠ ch·ªët ƒëi·ªán n∆∞·ªõc h√†ng th√°ng
     - Hi·ªÉn th·ªã c·∫£nh b√°o v∆∞·ª£t ng∆∞·ª°ng d√≤ng ƒëi·ªán
     - C√≥ th·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc ho·∫∑c x√≥a to√†n b·ªô
  
  TH∆Ø VI·ªÜN S·ª¨ D·ª§NG:
  - Chart.js: V·∫Ω ƒë·ªì th·ªã ƒë∆∞·ªùng
  - Firebase SDK: L·∫•y d·ªØ li·ªáu realtime
  
  C√ÅC H√ÄM CH√çNH:
  - markAllRead(): ƒê√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o ƒë√£ ƒë·ªçc
  - deleteAllNotifications(): X√≥a to√†n b·ªô th√¥ng b√°o
  - parseVietnameseTime(): Chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng th·ªùi gian Vi·ªát Nam
  - render(): Render l·∫°i danh s√°ch th√¥ng b√°o
-->
<html lang="vi">
  <head>
    <!-- Meta charset UTF-8 ƒë·ªÉ h·ªó tr·ª£ ti·∫øng Vi·ªát -->
    <meta charset="UTF-8" />
    <title>ƒê·ªì th·ªã c√¥ng su·∫•t & l∆∞u l∆∞·ª£ng n∆∞·ªõc</title>

    <!-- CSS cho trang ƒë·ªì th·ªã -->
    <link rel="stylesheet" href="chart.css" />

    <!-- 
      Chart.js - Th∆∞ vi·ªán v·∫Ω ƒë·ªì th·ªã
      T√†i li·ªáu: https://www.chartjs.org/docs/
    -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- 
      PH·∫¶N ƒê·ªí TH·ªä REALTIME
      - Canvas ƒë·ªÉ Chart.js v·∫Ω ƒë·ªì th·ªã
      - ID: powerWaterChart
      - Hi·ªÉn th·ªã 2 dataset: C√¥ng su·∫•t v√† L∆∞u l∆∞·ª£ng n∆∞·ªõc
    -->
    <div class="chart-wrapper">
      <canvas id="powerWaterChart"></canvas>
    </div>

    <!-- 
      PH·∫¶N TH√îNG B√ÅO
      - Hi·ªÉn th·ªã danh s√°ch th√¥ng b√°o t·ª´ Firebase
      - C√≥ badge ƒë·∫øm s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc
      - C√≥ n√∫t ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc v√† x√≥a to√†n b·ªô
    -->
    <div class="noti-container">
      <!-- Header v·ªõi ti√™u ƒë·ªÅ v√† c√°c n√∫t ch·ª©c nƒÉng -->
      <div class="noti-header">
        <div class="left">
          <h2>Th√¥ng b√°o</h2>
          <!-- Badge hi·ªÉn th·ªã s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc -->
          <span id="unreadCount" class="badge">0</span>
        </div>
        <div class="header-buttons">
          <!-- N√∫t ƒë√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc -->
          <button onclick="markAllRead()">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
          <!-- N√∫t x√≥a to√†n b·ªô th√¥ng b√°o -->
          <button class="delete-all-btn" onclick="deleteAllNotifications()">
            X√≥a to√†n b·ªô
          </button>
        </div>
      </div>

      <!-- Danh s√°ch th√¥ng b√°o - ƒë∆∞·ª£c render b·∫±ng JavaScript -->
      <div class="noti-list" id="notiList">
        <!-- C√°c th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
      </div>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      /* ===== FIREBASE CONFIG ===== */
      firebase.initializeApp({
        apiKey: "AIzaSyD9Vmq5O9sVpOsTtQ3qNIyggsIaobNfBMw",
        databaseURL: "https://do-an-high-default-rtdb.firebaseio.com/",
      });

      /* ===== CHART INIT ===== */
      const ctx = document.getElementById("powerWaterChart").getContext("2d");

      /* n·ªÅn canvas ƒë·ªÉ kh·ªèi b·ªã m·ªù */
      const canvasBgPlugin = {
        id: "bg",
        beforeDraw: (chart) => {
          const { ctx, width, height } = chart;
          ctx.save();
          ctx.globalCompositeOperation = "destination-over";
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, width, height);
          ctx.restore();
        },
      };

      const chart = new Chart(ctx, {
        type: "line",
        plugins: [canvasBgPlugin],
        data: {
          labels: [],
          datasets: [
            {
              label: "C√¥ng su·∫•t (W)",
              data: [],
              borderColor: "#2563eb",
              backgroundColor: "rgba(37,99,235,0.12)",
              yAxisID: "yPower",
              tension: 0.35,
              pointRadius: 0,
            },
            {
              label: "L∆∞u l∆∞·ª£ng n∆∞·ªõc (mL/s)",
              data: [],
              borderColor: "#16a34a",
              backgroundColor: "rgba(22,163,74,0.12)",
              yAxisID: "yFlow",
              tension: 0.35,
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          layout: {
            padding: {
              top: 10,
              bottom: 10,
            },
          },
          scales: {
            x: {
              ticks: {
                color: "#374151",
                maxRotation: 45,
                minRotation: 0,
                font: { size: 11 },
              },
              grid: { color: "rgba(0,0,0,0.06)" },
            },
            yPower: {
              min: 0,
              max: 1000,
              ticks: {
                color: "#2563eb",
                font: { size: 12, weight: "500" },
                stepSize: 100,
              },
              grid: { color: "rgba(37,99,235,0.1)" },
              title: {
                display: true,
                text: "C√¥ng su·∫•t (W)",
                color: "#2563eb",
                font: { size: 14, weight: "600" },
              },
            },
            yFlow: {
              min: 0,
              max: 2000,
              position: "right",
              grid: { drawOnChartArea: false },
              ticks: {
                color: "#16a34a",
                font: { size: 12, weight: "500" },
                stepSize: 200,
              },
              title: {
                display: true,
                text: "L∆∞u l∆∞·ª£ng (mL/s)",
                color: "#16a34a",
                font: { size: 14, weight: "600" },
              },
            },
          },
          plugins: {
            legend: {
              labels: {
                color: "#111827",
                font: { weight: "600" },
              },
            },
          },
        },
      });

      /* ===== REALTIME UPDATE ‚Äì M·ªñI 1 GI√ÇY ===== */
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) return;

        const uid = user.uid;
        const dbRef = firebase.database().ref("users/" + uid);

        dbRef.on("value", (snap) => {
          const d = snap.val();
          if (!d) return;

          const now = new Date();
          const label =
            now.getHours() +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          chart.data.labels.push(label);
          chart.data.datasets[0].data.push(d.power ?? 0);
          chart.data.datasets[1].data.push(d.flow_ml_s ?? 0);

          // gi·ªØ t·ªëi ƒëa 120 ƒëi·ªÉm (~2 ph√∫t)
          if (chart.data.labels.length > 120) {
            chart.data.labels.shift();
            chart.data.datasets.forEach((ds) => ds.data.shift());
          }

          chart.update();
        });
      });
    </script>

    <script>
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) return;

        const uid = user.uid;
        const notiList = document.getElementById("notiList");
        const badge = document.getElementById("unreadCount");

        let notifications = [];

        /* ===== LOAD MONTHLY LOG ===== */
        firebase
          .database()
          .ref(`users/${uid}/logs/monthly`)
          .on("value", (snap) => {
            notifications = notifications.filter((n) => n.type !== "monthly");

            snap.forEach((child) => {
              const d = child.val();
              notifications.push({
                id: child.key,
                type: "monthly",
                unread: true,
                time: d.time,
                text:
                  `üìä Ch·ªët ƒëi·ªán & n∆∞·ªõc<br>` +
                  `üîå ƒêi·ªán nƒÉng: <b>${d.energy}</b> kWh<br>` +
                  `üíß T·ªïng n∆∞·ªõc: <b>${d.water_m3}</b> m¬≥`,
              });
            });

            render();
          });

        /* ===== LOAD ALERT LOG ===== */
        firebase
          .database()
          .ref(`users/${uid}/logs/alerts`)
          .limitToLast(20)
          .on("value", (snap) => {
            notifications = notifications.filter((n) => n.type !== "alert");

            snap.forEach((child) => {
              const d = child.val();
              notifications.push({
                id: child.key,
                type: "alert",
                unread: true,
                time: d.time,
                text:
                  `‚ö° <b>V∆∞·ª£t ng∆∞·ª°ng d√≤ng ƒëi·ªán</b><br>` +
                  `D√≤ng ƒëi·ªán: <b>${d.current}</b> A<br>` +
                  `Ng∆∞·ª°ng: <b>${d.threshold}</b> A`,
              });
            });

            render();
          });

        /* ===== PARSE TIME HELPER ===== */
        function parseVietnameseTime(timeStr) {
          // Format: "17:03:09 17/1/2026"
          const parts = timeStr.split(" ");
          if (parts.length !== 2) return new Date(timeStr);

          const timePart = parts[0]; // "17:03:09"
          const datePart = parts[1]; // "17/1/2026"

          const [day, month, year] = datePart.split("/");
          const [hours, minutes, seconds] = timePart.split(":");

          return new Date(year, month - 1, day, hours, minutes, seconds);
        }

        /* ===== RENDER UI ===== */
        function render() {
          notiList.innerHTML = "";
          let unread = 0;

          notifications
            .sort(
              (a, b) =>
                parseVietnameseTime(b.time) - parseVietnameseTime(a.time),
            )
            .forEach((n) => {
              if (n.unread) unread++;

              const div = document.createElement("div");
              div.className = "noti-item" + (n.unread ? " unread" : "");

              div.innerHTML = `
                    <div class="dot">${n.unread ? "‚óè" : ""}</div>
                    <div class="content">
                        <div class="text">${n.text}</div>
                        <div class="time">${n.time}</div>
                    </div>
                    ${
                      n.type === "alert"
                        ? `<button class="del" data-id="${n.id}">‚úñ</button>`
                        : ""
                    }
                `;

              div.onclick = () => {
                n.unread = false;
                render();
              };

              if (n.type === "alert") {
                div.querySelector(".del").onclick = (e) => {
                  e.stopPropagation();
                  firebase
                    .database()
                    .ref(`users/${uid}/logs/alerts/${n.id}`)
                    .remove();
                };
              }

              notiList.appendChild(div);
            });

          badge.innerText = unread;
          badge.style.display = unread ? "inline-block" : "none";
        }

        /* ===== MARK ALL READ ===== */
        window.markAllRead = () => {
          notifications.forEach((n) => (n.unread = false));
          render();
        };

        /* ===== DELETE ALL NOTIFICATIONS ===== */
        window.deleteAllNotifications = () => {
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ th√¥ng b√°o?"))
            return;

          // X√≥a alerts trong Firebase
          firebase.database().ref(`users/${uid}/logs/alerts`).remove();

          // X√≥a monthly logs trong Firebase
          firebase.database().ref(`users/${uid}/logs/monthly`).remove();

          // X√≥a local notifications array
          notifications = [];
          render();
        };
      });
    </script>
  </body>
</html>
