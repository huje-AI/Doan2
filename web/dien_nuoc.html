<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Gi√°m s√°t ƒëi·ªán n∆∞·ªõc</title>
    <link rel="stylesheet" href="dien_nuoc.css" />
  </head>
  <body>
    <div class="grid">
      <div class="card" id="energyCard">
        <div class="title">ƒêi·ªán nƒÉng</div>
        <div class="main-value">
          <span class="number" id="energy">0</span>
          <span class="unit">kWh</span>
        </div>
        <div class="trend" id="energyTrend"></div>
      </div>

      <div class="card" id="voltageCard">
        <div class="title">ƒêi·ªán √°p</div>
        <div class="main-value">
          <span class="number" id="voltage">0</span>
          <span class="unit">V</span>
        </div>
        <div class="trend" id="voltageTrend"></div>
      </div>

      <div class="card" id="currentCard">
        <div class="title">D√≤ng ƒëi·ªán</div>
        <div class="main-value">
          <span class="number" id="current">0</span>
          <span class="unit">A</span>
        </div>
        <div class="trend" id="currentTrend"></div>
      </div>

      <div class="card" id="powerCard">
        <div class="title">C√¥ng su·∫•t</div>
        <div class="main-value">
          <span class="number" id="power">0</span>
          <span class="unit">W</span>
        </div>
        <div class="trend" id="powerTrend"></div>
      </div>

      <div class="card" id="flowCard">
        <div class="title">L∆∞u l∆∞·ª£ng n∆∞·ªõc</div>
        <div class="main-value">
          <span class="number" id="flow">0</span>
          <span class="unit">mL/s</span>
        </div>
        <div class="trend" id="flowTrend"></div>
      </div>

      <div class="card" id="waterCard">
        <div class="title">T·ªïng n∆∞·ªõc</div>
        <div class="main-value">
          <span class="number" id="water">0</span>
          <span class="unit">m¬≥</span>
        </div>
        <div class="trend" id="waterTrend"></div>
      </div>
    </div>

    <!-- PH·∫¶N CH·ªêT ƒêI·ªÜN N∆Ø·ªöC TH√ÅNG -->
    <div class="monthly-section">
      <div class="monthly-header">
        <h2>üìÖ Ch·ªët ƒëi·ªán n∆∞·ªõc h√†ng th√°ng</h2>
        <div class="header-actions">
          <div class="schedule-info" id="scheduleInfo">
            <span class="schedule-label">‚è∞ L·ªãch ch·ªët ti·∫øp theo:</span>
            <span class="schedule-time" id="scheduleTime">Ch∆∞a c√†i ƒë·∫∑t</span>
            <span class="schedule-status" id="scheduleStatus"></span>
          </div>
          <button id="btnChotNgay" class="btn-chot-ngay">üíæ Ch·ªët ngay</button>
        </div>
      </div>

      <!-- B·∫£ng so s√°nh -->
      <div class="comparison-container">
        <h3>üìä So s√°nh s·ª≠ d·ª•ng ƒëi·ªán n∆∞·ªõc</h3>
        <div class="comparison-selectors">
          <div class="selector-group">
            <label>Th√°ng tr∆∞·ªõc:</label>
            <select id="prevMonthSelect"></select>
          </div>
          <div class="selector-group">
            <label>Th√°ng sau:</label>
            <select id="currMonthSelect"></select>
          </div>
          <button id="btnCompare" class="btn-compare">So s√°nh</button>
        </div>

        <table class="comparison-table" id="comparisonTable">
          <thead>
            <tr>
              <th>Ch·ªâ s·ªë</th>
              <th id="thPrevMonth">Th√°ng tr∆∞·ªõc</th>
              <th id="thCurrMonth">Th√°ng sau</th>
              <th>Ch√™nh l·ªách</th>
              <th>T√¨nh tr·∫°ng</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>üîå ƒêi·ªán nƒÉng (kWh)</td>
              <td id="prevEnergy">--</td>
              <td id="currEnergy">--</td>
              <td id="diffEnergy">--</td>
              <td id="statusEnergy">--</td>
            </tr>
            <tr>
              <td>üíß T·ªïng n∆∞·ªõc (m¬≥)</td>
              <td id="prevWater">--</td>
              <td id="currWater">--</td>
              <td id="diffWater">--</td>
              <td id="statusWater">--</td>
            </tr>
          </tbody>
        </table>

        <div class="comparison-summary" id="comparisonSummary">
          <p>Ch·ªçn 2 th√°ng v√† nh·∫•n "So s√°nh" ƒë·ªÉ xem k·∫øt qu·∫£.</p>
        </div>
      </div>

      <!-- L·ªãch s·ª≠ ch·ªët -->
      <div class="history-container">
        <h3>üìú L·ªãch s·ª≠ ch·ªët ƒëi·ªán n∆∞·ªõc</h3>
        <div class="history-list" id="historyList">
          <p class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu ch·ªët.</p>
        </div>
      </div>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
      firebase.initializeApp({
        apiKey: "AIzaSyD9Vmq5O9sVpOsTtQ3qNIyggsIaobNfBMw",
        databaseURL: "https://do-an-high-default-rtdb.firebaseio.com/",
      });

      let oldData = {};
      let voltageStandard = 220; // Gi√° tr·ªã ƒëi·ªán √°p chu·∫©n m·∫∑c ƒë·ªãnh

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          console.warn("Ch∆∞a ƒëƒÉng nh·∫≠p");
          return;
        }

        const uid = user.uid;
        const dbRef = firebase.database().ref("users/" + uid);

        // Load gi√° tr·ªã ƒëi·ªán √°p chu·∫©n t·ª´ settings
        firebase
          .database()
          .ref(`users/${uid}/settings`)
          .on("value", (snap) => {
            const s = snap.val();
            if (s && s.voltage_standard) {
              voltageStandard = s.voltage_standard;
            }
          });

        dbRef.on("value", (snap) => {
          const d = snap.val();
          if (!d) return;

          console.log("Firebase data:", d); // üëà test

          updateCard("energy", d.energy ?? 0, "kWh");
          updateCardVoltage("voltage", d.voltage ?? 0, "V"); // D√πng h√†m ri√™ng cho ƒëi·ªán √°p
          updateCard("current", d.current ?? 0, "A");
          updateCard("power", d.power ?? 0, "W");
          updateCard("flow", d.flow_ml_s ?? 0, "mL/s");
          updateCard("water", d.water_m3 ?? 0, "m¬≥");

          oldData = d;
        });
      });

      // H√†m ri√™ng cho ƒëi·ªán √°p - so s√°nh v·ªõi gi√° tr·ªã chu·∫©n
      function updateCardVoltage(key, value, unit) {
        const numEl = document.getElementById(key);
        const trendEl = document.getElementById(key + "Trend");
        const card = document.getElementById(key + "Card");

        const diff = value - voltageStandard;

        numEl.innerText = value;
        card.classList.remove("up", "down");

        if (diff > 0) {
          card.classList.add("up");
          trendEl.innerHTML = `‚ñ≤ +${diff.toFixed(1)} ${unit} (chu·∫©n: ${voltageStandard}V)`;
        } else if (diff < 0) {
          card.classList.add("down");
          trendEl.innerHTML = `‚ñº ${diff.toFixed(1)} ${unit} (chu·∫©n: ${voltageStandard}V)`;
        } else {
          trendEl.innerHTML = `‚úì ƒê√∫ng chu·∫©n ${voltageStandard}V`;
        }
      }

      function updateCard(key, value, unit) {
        const numEl = document.getElementById(key);
        const trendEl = document.getElementById(key + "Trend");
        const card = document.getElementById(key + "Card");

        const oldVal = oldData[key] ?? value;
        const diff = value - oldVal;

        numEl.innerText = value;
        card.classList.remove("up", "down");

        if (diff > 0) {
          card.classList.add("up");
          trendEl.innerHTML = `‚ñ≤ +${diff.toFixed(2)} ${unit}`;
        } else if (diff < 0) {
          card.classList.add("down");
          trendEl.innerHTML = `‚ñº ${diff.toFixed(2)} ${unit}`;
        } else {
          trendEl.innerHTML = "‚Äî Kh√¥ng ƒë·ªïi";
        }
      }

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) return;
        const uid = user.uid;

        let threshold = 10;
        let soundEnabled = false;

        const audio = document.getElementById("alertSound");

        // load setting realtime
        firebase
          .database()
          .ref(`users/${uid}/settings`)
          .on("value", (snap) => {
            const s = snap.val();
            if (!s) return;
            threshold = s.current_threshold ?? 10;
            soundEnabled = s.sound_enabled ?? false;
          });

        let lastAlertTime = 0; // ch·ªëng spam

        firebase
          .database()
          .ref(`users/${uid}/current`)
          .on("value", (snap) => {
            const current = snap.val();
            if (current == null) return;

            if (soundEnabled && current > threshold) {
              const now = Date.now();

              // ‚õî ch·ªâ c·∫£nh b√°o 1 l·∫ßn / 10 gi√¢y
              if (now - lastAlertTime < 10000) return;
              lastAlertTime = now;

              // üîä ph√°t √¢m thanh
              audio.currentTime = 0;
              audio.play().catch(() => {});

              // üìù ghi log v∆∞·ª£t ng∆∞·ª°ng
              firebase
                .database()
                .ref(`users/${uid}/logs/alerts/${now}`)
                .set({
                  current,
                  threshold,
                  time: new Date().toLocaleString("vi-VN"),
                });
            }
          });
      });

      let lastMonthlyKey = null;

      setInterval(() => {
        firebase
          .database()
          .ref(`users/${uid}/settings`)
          .once("value")
          .then((snap) => {
            const cfg = snap.val();
            if (!cfg || !cfg.close_at) return;

            const now = Date.now();

            // so theo ph√∫t (¬±30s)
            if (Math.abs(now - cfg.close_at) <= 30000) {
              const monthKey = new Date(cfg.close_at).toISOString().slice(0, 7);

              if (lastMonthlyKey === monthKey) return;
              lastMonthlyKey = monthKey;

              firebase
                .database()
                .ref(`users/${uid}`)
                .once("value")
                .then((dataSnap) => {
                  const d = dataSnap.val();
                  if (!d) return;

                  firebase
                    .database()
                    .ref(`users/${uid}/notifications/monthly/${monthKey}`)
                    .set({
                      type: "monthly",
                      text: `üìä Ch·ªët ƒëi·ªán & n∆∞·ªõc th√°ng ${monthKey}
üîå ƒêi·ªán nƒÉng: ${d.energy ?? 0} kWh
üíß T·ªïng n∆∞·ªõc: ${d.water_m3 ?? 0} m¬≥`,
                      time: new Date(cfg.close_at).toISOString(),
                      unread: true,
                    });
                });
            }
          });
      }, 60000);
    </script>

    <!-- SCRIPT CH·ªêT ƒêI·ªÜN N∆Ø·ªöC -->
    <script>
      let currentUid = null;
      let monthlyData = {};

      let closeDay = null;
      let closeTime = null;
      let autoCloseInterval = null;

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) return;
        currentUid = user.uid;

        // Load d·ªØ li·ªáu ch·ªët t·ª´ Firebase
        loadMonthlyData();

        // Load c√†i ƒë·∫∑t th·ªùi gian ch·ªët
        loadScheduleSettings();

        // B·∫Øt ƒë·∫ßu ki·ªÉm tra ch·ªët t·ª± ƒë·ªông
        startAutoCloseCheck();
      });

      function loadScheduleSettings() {
        firebase
          .database()
          .ref(`users/${currentUid}/settings`)
          .on("value", (snap) => {
            const s = snap.val();
            if (!s) {
              document.getElementById("scheduleTime").textContent =
                "Ch∆∞a c√†i ƒë·∫∑t";
              document.getElementById("scheduleStatus").textContent = "";
              return;
            }

            closeDay = s.close_day || null;
            closeTime = s.close_time || null;

            if (closeDay && closeTime) {
              const scheduleDate = new Date(closeDay + "T" + closeTime);
              const now = new Date();

              document.getElementById("scheduleTime").textContent =
                `${formatDate(closeDay)} l√∫c ${closeTime}`;

              if (scheduleDate > now) {
                document.getElementById("scheduleStatus").innerHTML =
                  '<span class="status-pending">‚è≥ ƒêang ch·ªù</span>';
              } else {
                document.getElementById("scheduleStatus").innerHTML =
                  '<span class="status-done">‚úÖ ƒê√£ ch·ªët</span>';
              }
            } else {
              document.getElementById("scheduleTime").textContent =
                "Ch∆∞a c√†i ƒë·∫∑t";
              document.getElementById("scheduleStatus").innerHTML =
                '<a href="setting.html" target="_top" class="link-setting">C√†i ƒë·∫∑t ngay ‚Üí</a>';
            }
          });
      }

      function formatDate(dateStr) {
        const [year, month, day] = dateStr.split("-");
        return `${day}/${month}/${year}`;
      }

      function startAutoCloseCheck() {
        // Ki·ªÉm tra m·ªói 30 gi√¢y
        autoCloseInterval = setInterval(() => {
          checkAndAutoClose();
        }, 30000);

        // Ki·ªÉm tra ngay khi load
        checkAndAutoClose();
      }

      function checkAndAutoClose() {
        if (!closeDay || !closeTime || !currentUid) return;

        const scheduleDate = new Date(closeDay + "T" + closeTime);
        const now = new Date();
        const diff = Math.abs(now - scheduleDate);

        // N·∫øu trong kho·∫£ng 1 ph√∫t c·ªßa th·ªùi gian ch·ªët
        if (diff <= 60000 && now >= scheduleDate) {
          const monthKey = scheduleDate.toISOString().slice(0, 7);

          // Ki·ªÉm tra ƒë√£ ch·ªët th√°ng n√†y ch∆∞a
          if (monthlyData[monthKey] && monthlyData[monthKey].auto_closed) {
            return; // ƒê√£ ch·ªët r·ªìi
          }

          // Th·ª±c hi·ªán ch·ªët t·ª± ƒë·ªông
          performAutoClose(monthKey, scheduleDate);
        }
      }

      function performAutoClose(monthKey, scheduleDate) {
        const energy =
          parseFloat(document.getElementById("energy").innerText) || 0;
        const water =
          parseFloat(document.getElementById("water").innerText) || 0;

        const recordData = {
          energy: energy,
          water: water,
          recorded_at: new Date().toLocaleString("vi-VN"),
          timestamp: Date.now(),
          auto_closed: true,
          scheduled_time: scheduleDate.toISOString(),
        };

        firebase
          .database()
          .ref(`users/${currentUid}/monthly_records/${monthKey}`)
          .set(recordData)
          .then(() => {
            console.log("‚úÖ ƒê√£ ch·ªët t·ª± ƒë·ªông th√°ng " + monthKey);

            // G·ª≠i th√¥ng b√°o l√™n Firebase
            firebase
              .database()
              .ref(`users/${currentUid}/notifications/monthly_close`)
              .set({
                type: "monthly_close",
                title: "üìä ƒê√£ ch·ªët ƒëi·ªán n∆∞·ªõc!",
                message: `Th√°ng ${formatMonth(monthKey)}: üîå ${energy} kWh | üíß ${water} m¬≥`,
                time: new Date().toISOString(),
                unread: true,
              });

            // G·ª≠i l·ªánh reset cho ESP8266 (ESP s·∫Ω reset v√† g·ª≠i gi√° tr·ªã 0 l√™n Firebase)
            firebase
              .database()
              .ref(`users/${currentUid}/reset_command`)
              .set(true)
              .then(() => {
                console.log("üîÑ ƒê√£ g·ª≠i l·ªánh reset cho ESP8266");
              });
          })
          .catch((err) => {
            console.error("‚ùå L·ªói ch·ªët t·ª± ƒë·ªông:", err);
          });
      }

      function loadMonthlyData() {
        firebase
          .database()
          .ref(`users/${currentUid}/monthly_records`)
          .on("value", (snap) => {
            monthlyData = snap.val() || {};
            updateMonthSelectors();
            updateHistoryList();
          });
      }

      // N√∫t ch·ªët ngay - ch·ªët t·ª©c th√¨ kh√¥ng c·∫ßn ch·ªù ƒë·∫øn gi·ªù
      document.getElementById("btnChotNgay").addEventListener("click", () => {
        if (!currentUid) {
          alert("Ch∆∞a ƒëƒÉng nh·∫≠p!");
          return;
        }

        const now = new Date();
        const monthKey = now.toISOString().slice(0, 7);

        // Ki·ªÉm tra ƒë√£ ch·ªët th√°ng n√†y ch∆∞a
        if (monthlyData[monthKey]) {
          if (
            !confirm(
              `Th√°ng ${formatMonth(monthKey)} ƒë√£ c√≥ d·ªØ li·ªáu. B·∫°n c√≥ mu·ªën ghi ƒë√® kh√¥ng?`,
            )
          ) {
            return;
          }
        }

        const energy =
          parseFloat(document.getElementById("energy").innerText) || 0;
        const water =
          parseFloat(document.getElementById("water").innerText) || 0;

        const recordData = {
          energy: energy,
          water: water,
          recorded_at: new Date().toLocaleString("vi-VN"),
          timestamp: Date.now(),
          auto_closed: false,
          manual: true,
        };

        firebase
          .database()
          .ref(`users/${currentUid}/monthly_records/${monthKey}`)
          .set(recordData)
          .then(() => {
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu local ngay l·∫≠p t·ª©c
            monthlyData[monthKey] = recordData;

            // C·∫≠p nh·∫≠t UI ngay
            updateMonthSelectors();
            updateHistoryList();

            alert(
              `‚úÖ ƒê√£ ch·ªët ƒëi·ªán n∆∞·ªõc th√°ng ${formatMonth(monthKey)} th√†nh c√¥ng!\nüîå ƒêi·ªán: ${energy} kWh\nüíß N∆∞·ªõc: ${water} m¬≥`,
            );

            // G·ª≠i l·ªánh reset cho ESP8266 (ESP s·∫Ω reset v√† g·ª≠i gi√° tr·ªã 0 l√™n Firebase)
            firebase
              .database()
              .ref(`users/${currentUid}/reset_command`)
              .set(true);
          })
          .catch((err) => {
            alert("‚ùå L·ªói: " + err.message);
          });
      });

      // Th√™m d·ªØ li·ªáu m·∫´u th√°ng 12 n·∫øu ch∆∞a c√≥
      function addSampleDataDecember() {
        if (!currentUid) return;

        const dec2025Key = "2025-12";

        // Ki·ªÉm tra ƒë√£ c√≥ d·ªØ li·ªáu th√°ng 12 ch∆∞a
        firebase
          .database()
          .ref(`users/${currentUid}/monthly_records/${dec2025Key}`)
          .once("value")
          .then((snap) => {
            if (!snap.val()) {
              // Th√™m d·ªØ li·ªáu m·∫´u th√°ng 12/2025
              const sampleData = {
                energy: 125.5,
                water: 8.234,
                recorded_at: "31/12/2025, 23:59:00",
                timestamp: new Date("2025-12-31T23:59:00").getTime(),
                auto_closed: true,
                sample_data: true,
              };

              firebase
                .database()
                .ref(`users/${currentUid}/monthly_records/${dec2025Key}`)
                .set(sampleData)
                .then(() => {
                  console.log("üìä ƒê√£ th√™m d·ªØ li·ªáu m·∫´u th√°ng 12/2025");
                });
            }
          });
      }

      // G·ªçi th√™m d·ªØ li·ªáu m·∫´u khi load
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          setTimeout(() => {
            addSampleDataDecember();
          }, 2000);
        }
      });

      function updateMonthSelectors() {
        const prevSelect = document.getElementById("prevMonthSelect");
        const currSelect = document.getElementById("currMonthSelect");

        const months = Object.keys(monthlyData).sort().reverse();

        prevSelect.innerHTML = "";
        currSelect.innerHTML = "";

        if (months.length === 0) {
          prevSelect.innerHTML = '<option value="">Ch∆∞a c√≥ d·ªØ li·ªáu</option>';
          currSelect.innerHTML = '<option value="">Ch∆∞a c√≥ d·ªØ li·ªáu</option>';
          return;
        }

        months.forEach((month) => {
          prevSelect.innerHTML += `<option value="${month}">${formatMonth(month)}</option>`;
          currSelect.innerHTML += `<option value="${month}">${formatMonth(month)}</option>`;
        });

        // M·∫∑c ƒë·ªãnh: th√°ng tr∆∞·ªõc l√† th√°ng c≈© nh·∫•t trong 2 th√°ng g·∫ßn nh·∫•t
        if (months.length >= 2) {
          prevSelect.value = months[1];
          currSelect.value = months[0];
        }
      }

      function formatMonth(monthStr) {
        const [year, month] = monthStr.split("-");
        return `Th√°ng ${parseInt(month)}/${year}`;
      }

      function updateHistoryList() {
        const historyList = document.getElementById("historyList");
        const months = Object.keys(monthlyData).sort().reverse();

        if (months.length === 0) {
          historyList.innerHTML =
            '<p class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu ch·ªët.</p>';
          return;
        }

        let html = "";
        months.forEach((month) => {
          const data = monthlyData[month];
          html += `
            <div class="history-item">
              <div class="history-month">${formatMonth(month)}</div>
              <div class="history-details">
                <span>üîå ${data.energy ?? 0} kWh</span>
                <span>üíß ${data.water ?? 0} m¬≥</span>
              </div>
              <div class="history-time">Ch·ªët l√∫c: ${data.recorded_at ?? "--"}</div>
              <button class="btn-delete" onclick="deleteRecord('${month}')">üóëÔ∏è</button>
            </div>
          `;
        });

        historyList.innerHTML = html;
      }

      // N√∫t so s√°nh
      document.getElementById("btnCompare").addEventListener("click", () => {
        const prevMonth = document.getElementById("prevMonthSelect").value;
        const currMonth = document.getElementById("currMonthSelect").value;

        if (!prevMonth || !currMonth) {
          alert("Vui l√≤ng ch·ªçn ƒë·ªß 2 th√°ng ƒë·ªÉ so s√°nh!");
          return;
        }

        if (prevMonth === currMonth) {
          alert("Vui l√≤ng ch·ªçn 2 th√°ng kh√°c nhau!");
          return;
        }

        const prevData = monthlyData[prevMonth];
        const currData = monthlyData[currMonth];

        if (!prevData || !currData) {
          alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho th√°ng ƒë√£ ch·ªçn!");
          return;
        }

        // C·∫≠p nh·∫≠t header b·∫£ng
        document.getElementById("thPrevMonth").textContent =
          formatMonth(prevMonth);
        document.getElementById("thCurrMonth").textContent =
          formatMonth(currMonth);

        // T√≠nh to√°n v√† hi·ªÉn th·ªã
        const prevEnergy = prevData.energy || 0;
        const currEnergy = currData.energy || 0;
        const diffEnergy = currEnergy - prevEnergy;

        const prevWater = prevData.water || 0;
        const currWater = currData.water || 0;
        const diffWater = currWater - prevWater;

        document.getElementById("prevEnergy").textContent =
          prevEnergy.toFixed(2);
        document.getElementById("currEnergy").textContent =
          currEnergy.toFixed(2);
        document.getElementById("diffEnergy").textContent =
          (diffEnergy >= 0 ? "+" : "") + diffEnergy.toFixed(2);
        document.getElementById("diffEnergy").className =
          diffEnergy > 0 ? "increase" : diffEnergy < 0 ? "decrease" : "";

        document.getElementById("prevWater").textContent = prevWater.toFixed(3);
        document.getElementById("currWater").textContent = currWater.toFixed(3);
        document.getElementById("diffWater").textContent =
          (diffWater >= 0 ? "+" : "") + diffWater.toFixed(3);
        document.getElementById("diffWater").className =
          diffWater > 0 ? "increase" : diffWater < 0 ? "decrease" : "";

        // Status
        document.getElementById("statusEnergy").innerHTML = getStatusHTML(
          diffEnergy,
          "ƒëi·ªán",
        );
        document.getElementById("statusWater").innerHTML = getStatusHTML(
          diffWater,
          "n∆∞·ªõc",
        );

        // Summary
        updateComparisonSummary(diffEnergy, diffWater, prevMonth, currMonth);
      });

      function getStatusHTML(diff, type) {
        if (diff > 0) {
          const percent =
            diff > 0 ? "+" + ((diff / Math.abs(diff)) * 100).toFixed(0) : 0;
          return `<span class="status-up">üìà TƒÉng</span>`;
        } else if (diff < 0) {
          return `<span class="status-down">üìâ Gi·∫£m</span>`;
        } else {
          return `<span class="status-equal">‚û°Ô∏è B·∫±ng</span>`;
        }
      }

      function updateComparisonSummary(
        diffEnergy,
        diffWater,
        prevMonth,
        currMonth,
      ) {
        const summary = document.getElementById("comparisonSummary");

        let energyMsg =
          diffEnergy > 0
            ? `‚ö†Ô∏è ƒêi·ªán nƒÉng <strong>tƒÉng ${diffEnergy.toFixed(2)} kWh</strong>`
            : diffEnergy < 0
              ? `‚úÖ ƒêi·ªán nƒÉng <strong>gi·∫£m ${Math.abs(diffEnergy).toFixed(2)} kWh</strong>`
              : `‚û°Ô∏è ƒêi·ªán nƒÉng <strong>kh√¥ng ƒë·ªïi</strong>`;

        let waterMsg =
          diffWater > 0
            ? `‚ö†Ô∏è N∆∞·ªõc <strong>tƒÉng ${diffWater.toFixed(3)} m¬≥</strong>`
            : diffWater < 0
              ? `‚úÖ N∆∞·ªõc <strong>gi·∫£m ${Math.abs(diffWater).toFixed(3)} m¬≥</strong>`
              : `‚û°Ô∏è N∆∞·ªõc <strong>kh√¥ng ƒë·ªïi</strong>`;

        summary.innerHTML = `
          <h4>üìã T√≥m t·∫Øt so s√°nh ${formatMonth(prevMonth)} ‚Üí ${formatMonth(currMonth)}</h4>
          <p>${energyMsg}</p>
          <p>${waterMsg}</p>
        `;
      }

      function deleteRecord(month) {
        if (
          !confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªØ li·ªáu th√°ng ${formatMonth(month)}?`)
        ) {
          return;
        }

        firebase
          .database()
          .ref(`users/${currentUid}/monthly_records/${month}`)
          .remove()
          .then(() => {
            alert("‚úÖ ƒê√£ x√≥a!");
          })
          .catch((err) => {
            alert("‚ùå L·ªói: " + err.message);
          });
      }
    </script>

    <audio
      id="alertSound"
      src="sounds/Cause I Love You.mp3"
      preload="auto"
    ></audio>
  </body>
</html>
