<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Gi√°m s√°t ƒëi·ªán n∆∞·ªõc</title>
    <link rel="stylesheet" href="dien_nuoc.css" />
  </head>
  <body>
    <div class="grid">
      <div class="card" id="energyCard">
        <div class="title">ƒêi·ªán nƒÉng</div>
        <div class="main-value">
          <span class="number" id="energy">0</span>
          <span class="unit">kWh</span>
        </div>
        <div class="trend" id="energyTrend"></div>
      </div>

      <div class="card" id="voltageCard">
        <div class="title">ƒêi·ªán √°p</div>
        <div class="main-value">
          <span class="number" id="voltage">0</span>
          <span class="unit">V</span>
        </div>
        <div class="trend" id="voltageTrend"></div>
      </div>

      <div class="card" id="currentCard">
        <div class="title">D√≤ng ƒëi·ªán</div>
        <div class="main-value">
          <span class="number" id="current">0</span>
          <span class="unit">A</span>
        </div>
        <div class="trend" id="currentTrend"></div>
      </div>

      <div class="card" id="powerCard">
        <div class="title">C√¥ng su·∫•t</div>
        <div class="main-value">
          <span class="number" id="power">0</span>
          <span class="unit">W</span>
        </div>
        <div class="trend" id="powerTrend"></div>
      </div>

      <div class="card" id="flowCard">
        <div class="title">L∆∞u l∆∞·ª£ng n∆∞·ªõc</div>
        <div class="main-value">
          <span class="number" id="flow">0</span>
          <span class="unit">mL/s</span>
        </div>
        <div class="trend" id="flowTrend"></div>
      </div>

      <div class="card" id="waterCard">
        <div class="title">T·ªïng n∆∞·ªõc</div>
        <div class="main-value">
          <span class="number" id="water">0</span>
          <span class="unit">m¬≥</span>
        </div>
        <div class="trend" id="waterTrend"></div>
      </div>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
      firebase.initializeApp({
        apiKey: "AIzaSyD9Vmq5O9sVpOsTtQ3qNIyggsIaobNfBMw",
        databaseURL: "https://do-an-high-default-rtdb.firebaseio.com/",
      });

      let oldData = {};

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          console.warn("Ch∆∞a ƒëƒÉng nh·∫≠p");
          return;
        }

        const uid = user.uid;
        const dbRef = firebase.database().ref("users/" + uid);

        dbRef.on("value", (snap) => {
          const d = snap.val();
          if (!d) return;

          console.log("Firebase data:", d); // üëà test

          updateCard("energy", d.energy ?? 0, "kWh");
          updateCard("voltage", d.voltage ?? 0, "V");
          updateCard("current", d.current ?? 0, "A");
          updateCard("power", d.power ?? 0, "W");
          updateCard("flow", d.flow_ml_s ?? 0, "mL/s");
          updateCard("water", d.water_m3 ?? 0, "m¬≥");

          oldData = d;
        });
      });

      function updateCard(key, value, unit) {
        const numEl = document.getElementById(key);
        const trendEl = document.getElementById(key + "Trend");
        const card = document.getElementById(key + "Card");

        const oldVal = oldData[key] ?? value;
        const diff = value - oldVal;

        numEl.innerText = value;
        card.classList.remove("up", "down");

        if (diff > 0) {
          card.classList.add("up");
          trendEl.innerHTML = `‚ñ≤ +${diff.toFixed(2)} ${unit}`;
        } else if (diff < 0) {
          card.classList.add("down");
          trendEl.innerHTML = `‚ñº ${diff.toFixed(2)} ${unit}`;
        } else {
          trendEl.innerHTML = "‚Äî Kh√¥ng ƒë·ªïi";
        }
      }

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) return;
        const uid = user.uid;

        let threshold = 10;
        let soundEnabled = false;

        const audio = document.getElementById("alertSound");

        // load setting realtime
        firebase
          .database()
          .ref(`users/${uid}/settings`)
          .on("value", (snap) => {
            const s = snap.val();
            if (!s) return;
            threshold = s.current_threshold ?? 10;
            soundEnabled = s.sound_enabled ?? false;
          });

        let lastAlertTime = 0; // ch·ªëng spam

        firebase
          .database()
          .ref(`users/${uid}/current`)
          .on("value", (snap) => {
            const current = snap.val();
            if (current == null) return;

            if (soundEnabled && current > threshold) {
              const now = Date.now();

              // ‚õî ch·ªâ c·∫£nh b√°o 1 l·∫ßn / 10 gi√¢y
              if (now - lastAlertTime < 10000) return;
              lastAlertTime = now;

              // üîä ph√°t √¢m thanh
              audio.currentTime = 0;
              audio.play().catch(() => {});

              // üìù ghi log v∆∞·ª£t ng∆∞·ª°ng
              firebase
                .database()
                .ref(`users/${uid}/logs/alerts/${now}`)
                .set({
                  current,
                  threshold,
                  time: new Date().toLocaleString("vi-VN"),
                });
            }
          });
      });

      let lastMonthlyKey = null;

      setInterval(() => {
        firebase
          .database()
          .ref(`users/${uid}/settings`)
          .once("value")
          .then((snap) => {
            const cfg = snap.val();
            if (!cfg || !cfg.close_at) return;

            const now = Date.now();

            // so theo ph√∫t (¬±30s)
            if (Math.abs(now - cfg.close_at) <= 30000) {
              const monthKey = new Date(cfg.close_at).toISOString().slice(0, 7);

              if (lastMonthlyKey === monthKey) return;
              lastMonthlyKey = monthKey;

              firebase
                .database()
                .ref(`users/${uid}`)
                .once("value")
                .then((dataSnap) => {
                  const d = dataSnap.val();
                  if (!d) return;

                  firebase
                    .database()
                    .ref(`users/${uid}/notifications/monthly/${monthKey}`)
                    .set({
                      type: "monthly",
                      text: `üìä Ch·ªët ƒëi·ªán & n∆∞·ªõc th√°ng ${monthKey}
üîå ƒêi·ªán nƒÉng: ${d.energy ?? 0} kWh
üíß T·ªïng n∆∞·ªõc: ${d.water_m3 ?? 0} m¬≥`,
                      time: new Date(cfg.close_at).toISOString(),
                      unread: true,
                    });
                });
            }
          });
      }, 60000);
    </script>

    <audio
      id="alertSound"
      src="sounds/Cause I Love You.mp3"
      preload="auto"
    ></audio>
  </body>
</html>
