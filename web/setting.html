<!doctype html>
<!--
  ============================================================
  FILE: setting.html
  MÔ TẢ: Trang cài đặt hệ thống giám sát điện nước
  ============================================================
  
  HƯỚNG DẪN SỬ DỤNG:
  1. NGƯỠNG DÒNG ĐIỆN CẢNH BÁO:
     - Kéo thanh slider để đặt ngưỡng (0 - 20A)
     - Khi dòng điện vượt ngưỡng sẽ ghi log và phát âm thanh
  
  2. ĐIỆN ÁP CHUẨN:
     - Đặt giá trị điện áp chuẩn để so sánh (thường là 220V)
     - Phạm vi: 180V - 250V
  
  3. ÂM THANH CẢNH BÁO:
     - Bật/tắt âm thanh khi có cảnh báo vượt ngưỡng
  
  4. CHỐT ĐIỆN NƯỚC HÀNG THÁNG:
     - Chọn ngày và giờ để tự động chốt điện nước
     - Hệ thống sẽ lưu dữ liệu vào lịch sử
  
  LƯU TRỮ FIREBASE:
  - Tất cả cài đặt được lưu vào: users/{uid}/settings
  - Các trường: current_threshold, voltage_standard, sound_enabled,
                close_day, close_time, updated_at
  
  CÁC HÀM CHÍNH:
  - save(): Lưu cài đặt vào Firebase
  - Các event handler cho input (oninput, onchange)
-->
<html lang="vi">
  <head>
    <!-- Meta charset UTF-8 để hỗ trợ tiếng Việt -->
    <meta charset="UTF-8" />
    <title>Cài đặt hệ thống</title>
    <!-- CSS cho trang cài đặt -->
    <link rel="stylesheet" href="setting.css" />
  </head>

  <body>
    <!-- 
      CARD 1: NGƯỠNG DÒNG ĐIỆN CẢNH BÁO
      - Slider điều chỉnh ngưỡng từ 0A đến 20A
      - Step: 0.1A cho độ chính xác cao
      - Khi dòng điện vượt ngưỡng sẽ phát cảnh báo
    -->
    <div class="card">
      <h3>Ngưỡng dòng điện cảnh báo</h3>
      <div class="row">
        <!-- Slider ngưỡng dòng điện: min=0A, max=20A, step=0.1A -->
        <input type="range" min="0" max="20" step="0.1" value="0" id="range" />
        <b><span id="rangeVal">10</span> A</b>
      </div>
      <div class="desc">Vượt ngưỡng sẽ ghi log và phát âm thanh</div>
    </div>

    <!-- 
      CARD 2: ĐIỆN ÁP CHUẨN
      - Slider điều chỉnh điện áp chuẩn từ 180V đến 250V
      - Mặc định: 220V (điện áp tiêu chuẩn Việt Nam)
      - Dùng để so sánh với điện áp thực tế
    -->
    <div class="card">
      <h3>⚡ Điện áp chuẩn (V)</h3>
      <div class="row">
        <!-- Slider điện áp chuẩn: min=180V, max=250V, step=1V -->
        <input
          type="range"
          min="180"
          max="250"
          step="1"
          value="220"
          id="voltageStandard"
        />
        <b><span id="voltageVal">220</span> V</b>
      </div>
      <div class="desc">Giá trị điện áp chuẩn để so sánh (thường là 220V)</div>
    </div>

    <!-- 
      CARD 3: ÂM THANH CẢNH BÁO
      - Toggle switch bật/tắt âm thanh
      - Khi bật, sẽ phát âm thanh khi có cảnh báo vượt ngưỡng
    -->
    <div class="card">
      <h3>Âm thanh cảnh báo</h3>

      <div class="row">
        <!-- Toggle switch cho âm thanh -->
        <label class="toggle">
          <input type="checkbox" id="sound" />
          <span class="slider"></span>
        </label>
        <!-- Trạng thái hiện tại: Đang bật/tắt -->
        <span id="soundText">Đang tắt</span>
      </div>
    </div>

    <!-- 
      CARD 4: CHỐT ĐIỆN NƯỚC HÀNG THÁNG
      - Chọn ngày và giờ để tự động chốt
      - Khi đến thời gian, hệ thống sẽ lưu dữ liệu vào lịch sử
    -->
    <div class="card">
      <h3>Chốt điện & nước hàng tháng</h3>
      <div class="row">
        <!-- Input chọn ngày chốt -->
        <input type="date" id="date" />
        <!-- Input chọn giờ chốt -->
        <input type="time" id="time" />
      </div>
      <!-- Hiển thị preview thời gian đã chọn -->
      <div class="desc" id="preview">Chưa chọn thời gian</div>
    </div>

    <!-- 
      NÚT LƯU CÀI ĐẶT
      - Nhấn để lưu tất cả cài đặt vào Firebase
      - Hiển thị thông báo "Đã lưu cài đặt" khi thành công
    -->
    <div class="save">
      <button onclick="save()">Lưu cài đặt</button>
      <!-- Thông báo trạng thái lưu -->
      <span class="log" id="log"></span>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      firebase.initializeApp({
        apiKey: "AIzaSyD9Vmq5O9sVpOsTtQ3qNIyggsIaobNfBMw",
        databaseURL: "https://do-an-high-default-rtdb.firebaseio.com/",
      });

      const range = document.getElementById("range");
      const rangeVal = document.getElementById("rangeVal");
      const voltageStandard = document.getElementById("voltageStandard");
      const voltageVal = document.getElementById("voltageVal");
      const sound = document.getElementById("sound");
      const soundText = document.getElementById("soundText");

      const date = document.getElementById("date");
      const time = document.getElementById("time");
      const preview = document.getElementById("preview");
      const log = document.getElementById("log");

      range.oninput = () => (rangeVal.innerText = range.value);
      voltageStandard.oninput = () =>
        (voltageVal.innerText = voltageStandard.value);
      sound.onchange = () =>
        (soundText.innerText = sound.checked ? "Đang bật" : "Đang tắt");

      date.onchange = time.onchange = () => {
        preview.innerText =
          date.value && time.value
            ? `Chốt vào ${date.value} – ${time.value}`
            : "Chưa chọn thời gian";
      };

      async function save() {
        firebase.auth().onAuthStateChanged(async (user) => {
          if (!user) {
            alert("Chưa đăng nhập");
            return;
          }

          const uid = user.uid;

          const settings = {
            current_threshold: Number(range.value),
            voltage_standard: Number(voltageStandard.value),
            sound_enabled: sound.checked,
            close_day: date.value,
            close_time: time.value,
            updated_at: Date.now(),
          };

          await firebase.database().ref(`users/${uid}/settings`).set(settings);

          log.innerText = "✔ Đã lưu cài đặt";
          setTimeout(() => (log.innerText = ""), 3000);
        });
      }
    </script>

    <script>
      /* ===== LOAD SETTING KHI MỞ TRANG ===== */
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) return;

        const uid = user.uid;

        firebase
          .database()
          .ref(`users/${uid}/settings`)
          .once("value", (snap) => {
            const s = snap.val();
            if (!s) return;

            /* === LOAD NGƯỠNG === */
            range.value = s.current_threshold ?? 10;
            rangeVal.innerText = range.value;

            /* === LOAD ĐIỆN ÁP CHUẨN === */
            voltageStandard.value = s.voltage_standard ?? 220;
            voltageVal.innerText = voltageStandard.value;

            /* === LOAD ÂM THANH === */
            sound.checked = s.sound_enabled ?? false;
            soundText.innerText = sound.checked ? "Đang bật" : "Đang tắt";

            /* === LOAD NGÀY GIỜ CHỐT === */
            date.value = s.close_day ?? "";
            time.value = s.close_time ?? "";

            preview.innerText =
              s.close_day && s.close_time
                ? `Chốt vào ${s.close_day} – ${s.close_time}`
                : "Chưa chọn thời gian";
          });
      });
    </script>
  </body>
</html>
